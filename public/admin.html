<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
<div class="container">
  <div class="header" style="flex-direction:column;gap:6px">
    <div class="brand">Auction Admin</div>
    <div class="row" style="gap:8px">
      <span class="tag">Sold: <b id="soldCount">0</b></span>
      <span class="tag">Unsold: <b id="unsoldCount">0</b></span>
    </div>
  </div>

  <div class="board">
    <div class="row" style="margin-bottom:10px">
      <input id="pass" type="password" class="input" placeholder="Admin pass" style="min-width:180px"/>
      <button id="login" class="btn primary">Sign In</button>
      <a class="btn" href="/api/export.pdf" title="Download PDF" aria-label="Download PDF">⤓ PDF</a>
    </div>

    <div class="controls" style="margin-bottom:10px">
      <button id="start" class="btn accent">▶ Start</button>
      <button id="startNext" class="btn primary">Start Next</button>
      <button id="pause" class="btn">⏸ Pause</button>
      <button id="sell" class="btn success">✓ Sell</button>
      <button id="next" class="btn">» Next</button>
    </div>

    <div class="grid grid-50">
      <div>
        <div class="row"><span class="tag" id="phaseTag">Idle</span></div>
        <div class="stat"><div class="label">Current Player</div></div>
        <div class="stat"><div class="value" id="cur">-</div></div>
        <div class="stat"><div class="label">Leading Bid</div></div>
        <div class="stat"><div class="value" id="lead">-</div></div>
        <div class="stat"><div class="label">Time Left</div></div>
        <div class="stat"><div class="value" id="cd">0s</div></div>
      </div>
      <div>
        <div class="stat"><div class="label">Up Next</div></div>
        <div class="stat"><div class="value" id="upNext">-</div></div>
        <div class="row"><span class="label">Queue</span><span class="tag" id="qCount">0</span></div>
        <div class="list" style="margin-top:6px"><pre id="pending"></pre></div>
      </div>
    </div>
  </div>

  <div class="grid grid-50" style="margin-top:16px">
    <div class="board list"><pre id="teams"></pre></div>
    <div class="board list"><pre id="history"></pre></div>
  </div>

  <div id="msg" class="footer" style="margin-top:8px"></div>
</div>
<script>
  function wsUrl(){const p=location.protocol==='https:'?'wss':'ws';return `${p}://${location.host}/ws`}
  let ws;const ui={
    pass:pass, login:login, start:start, startNext:startNext, pause:pause, sell:sell, next:next,
    msg:msg, phaseTag:phaseTag, cur:cur, lead:lead, cd:cd, upNext:upNext, qCount:qCount, pending:pending,
    teams:document.getElementById('teams'), history:document.getElementById('history'),
    sold:document.getElementById('soldCount'), unsold:document.getElementById('unsoldCount')
  };
  function connect(){
    ws=new WebSocket(wsUrl());
    ws.onopen=()=>{const q=new URLSearchParams(location.search).get('pass')||ui.pass.value; if(q) ws.send(JSON.stringify({type:'login',role:'admin',pass:q}))};
    ws.onmessage=(ev)=>{try{const d=JSON.parse(ev.data); if(d.type==='error') return ui.msg.textContent='Error: '+d.error; if(d.type==='login_ok') {ui.msg.textContent=''; return;} if(d.type==='state') return render(d.payload);}catch{}};
    ws.onclose=()=>setTimeout(connect,800);
  }
  connect();
  ui.login.onclick=()=>ws.send(JSON.stringify({type:'login',role:'admin',pass:ui.pass.value}));
  ui.start.onclick=()=>ws.send(JSON.stringify({type:'admin',action:'start'}));
  ui.startNext.onclick=()=>ws.send(JSON.stringify({type:'admin',action:'startNext'}));
  ui.pause.onclick=()=>ws.send(JSON.stringify({type:'admin',action:'pause'}));
  ui.sell.onclick=()=>ws.send(JSON.stringify({type:'admin',action:'closeAndSell'}));
  ui.next.onclick=()=>ws.send(JSON.stringify({type:'admin',action:'next'}));
  // HTTP fallback poll
  setInterval(async()=>{try{const r=await fetch('/debug/state',{cache:'no-store'}); render(await r.json());}catch{}},1000);
  let cdTimer; const last={cur:null, upNext:null, lead:null, sold:-1, unsold:-1};
  function bump(el,cls='fade-in'){el.classList.remove(cls); void el.offsetWidth; el.classList.add(cls); setTimeout(()=>el.classList.remove(cls),400);}
  function render(state){
    ui.phaseTag.textContent=state.auction.phase; ui.phaseTag.className='tag '+(state.auction.phase==='running'?'success':state.auction.phase==='paused'?'warn':'');
    const curPlayer=state.auction.currentPlayer||'-'; if(curPlayer!==last.cur){ui.cur.textContent=curPlayer; bump(ui.cur); last.cur=curPlayer;} else {ui.cur.textContent=curPlayer;}
    if(state.auction.currentBid){const t=state.teams.find(x=>x.id===state.auction.currentBid.teamId); const l=`${t?t.name:''} ${state.auction.currentBid.amount}`.trim(); if(l!==last.lead){ui.lead.textContent=l; bump(ui.lead,'pulse'); last.lead=l;} else ui.lead.textContent=l;}
    else {ui.lead.textContent='-'; last.lead='-';}
    const up=state.queue.upNext?state.queue.upNext.name:'-'; if(up!==last.upNext){ui.upNext.textContent=up; bump(ui.upNext);} else ui.upNext.textContent=up;
    ui.qCount.textContent=state.queue.count;
    ui.pending.textContent=(state.queue.preview||[]).map((n,i)=>`${i+1}. ${n}`).join('\n');
    ui.teams.textContent=state.teams.map(t=>`${t.name||''} - tokens: ${t.tokens}`).join('\n');
    ui.history.textContent=state.auction.history.map(h=>`${new Date(h.ts).toLocaleTimeString()} | ${h.unsold?(h.player+' unsold'):(h.player+' sold to '+(state.teams.find(t=>t.id===h.teamId)?.name||'')+' for '+h.amount)}`).join('\n');
    if(cdTimer) clearInterval(cdTimer);
    const deadline=state.auction.deadlineAt||0; const tick=()=>{const s=Math.max(0,Math.ceil((deadline-Date.now())/1000)); ui.cd.textContent=s+'s';};
    tick(); if(deadline) cdTimer=setInterval(tick,500);
    if(state.counts){ if(state.counts.sold!==last.sold){ui.sold.textContent=state.counts.sold; bump(ui.sold);} else ui.sold.textContent=state.counts.sold; if(state.counts.unsold!==last.unsold){ui.unsold.textContent=state.counts.unsold; bump(ui.unsold);} else ui.unsold.textContent=state.counts.unsold; }
  }
</script>
</body>
</html>
