<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
<div class="container">
  <div class="header" style="flex-direction:column;gap:6px">
    <div class="brand">Auction Admin</div>
    <div class="row" style="gap:8px">
      <span class="tag">Sold: <b id="soldCount">0</b></span>
      <span class="tag">Unsold: <b id="unsoldCount">0</b></span>
    </div>
  </div>

  <div class="board">
    <div id="loginRow" class="row" style="margin-bottom:10px">
      <input id="pass" type="password" class="input" placeholder="Admin pass" style="min-width:180px"/>
      <button id="login" class="btn primary">Sign In</button>
      <a id="export" class="btn" href="/api/export.xlsx" title="Download Excel" aria-label="Download Excel" style="display:none">⤓ Excel</a>
    </div>

    <div id="private" style="display:none">
      <div class="controls" style="margin-bottom:10px">
        <button id="start" class="btn accent">▶ Start</button>
        <button id="startNext" class="btn primary">Start Next</button>
        <button id="sell" class="btn success">✓ Sell Now</button>
      </div>

      <div class="grid grid-50">
      <div>
        <div class="row"><span class="tag" id="phaseTag">Idle</span></div>
        <div class="stat"><div class="label">Current Player</div></div>
        <div class="stat"><div class="value" id="cur">-</div></div>
        <div class="stat"><div class="label">Base Price</div></div>
        <div class="stat"><div class="value" id="base">-</div></div>
        <div class="stat"><div class="label">Leading Bid</div></div>
        <div class="stat"><div class="value" id="lead">-</div></div>
        <div class="stat"><div class="label">Time Left</div></div>
        <div class="stat"><div class="value" id="cd">0s</div></div>
      </div>
      <div>
        <div class="stat"><div class="label">Up Next</div></div>
        <div class="stat"><div class="value" id="upNext">-</div></div>
        <div class="row"><span class="label">Queue</span><span class="tag" id="qCount">0</span></div>
        <div class="list" style="margin-top:6px"><pre id="pending"></pre></div>
        <div class="stat" style="margin-top:10px"><div class="label">Player Submissions</div></div>
        <div class="row">
          <input id="subMinutes" class="input" type="number" min="1" step="1" placeholder="Minutes" style="width:120px"/>
          <button id="subOpen" class="btn accent">Open for minutes</button>
          <button id="subClose" class="btn">Close now</button>
        </div>
        <div class="row" style="margin-top:6px"><span class="tag">Time left: <b id="subLeft">-</b></span></div>
      </div>
    </div>
    </div>
  </div>

  <div id="private2" class="grid grid-50" style="margin-top:16px; display:none">
    <div class="board list"><pre id="teams"></pre></div>
    <div class="board list"><pre id="history"></pre></div>
  </div>

  <div id="msg" class="footer" style="margin-top:8px"></div>
</div>
<script>
  function wsUrl(){const p=location.protocol==='https:'?'wss':'ws';return `${p}://${location.host}/ws`}
  let ws;const ui={
    pass:pass, login:login, start:start, startNext:startNext, sell:sell,
    msg:msg, phaseTag:phaseTag, cur:cur, base:base, lead:lead, cd:cd, upNext:upNext, qCount:qCount, pending:pending,
    teams:document.getElementById('teams'), history:document.getElementById('history'),
    sold:document.getElementById('soldCount'), unsold:document.getElementById('unsoldCount'),
    subMinutes:document.getElementById('subMinutes'), subOpen:document.getElementById('subOpen'), subClose:document.getElementById('subClose'), subLeft:document.getElementById('subLeft'),
    privateWrap:document.getElementById('private'), privateWrap2:document.getElementById('private2'), exportLink:document.getElementById('export'), loginRow:document.getElementById('loginRow')
  };
  function connect(){
    ws=new WebSocket(wsUrl());
    ws.onopen=()=>{};
    ws.onmessage=(ev)=>{try{const d=JSON.parse(ev.data); if(d.type==='error') return ui.msg.textContent='Error: '+d.error; if(d.type==='login_ok') {ui.msg.textContent=''; ui.privateWrap.style.display=''; ui.privateWrap2.style.display=''; ui.exportLink.style.display=''; ui.pass.disabled=true; ui.login.disabled=true; return;} if(d.type==='state') return render(d.payload);}catch{}};
    ws.onclose=()=>setTimeout(connect,800);
  }
  connect();
  ui.login.onclick=()=>ws.send(JSON.stringify({type:'login',role:'admin',pass:ui.pass.value}));
  ui.start.onclick=()=>ws.send(JSON.stringify({type:'admin',action:'start'}));
  ui.startNext.onclick=()=>ws.send(JSON.stringify({type:'admin',action:'startNext'}));
  ui.sell.onclick=()=>ws.send(JSON.stringify({type:'admin',action:'closeAndSell'}));
  ui.subOpen.onclick=()=>{const m=parseInt(ui.subMinutes.value,10); if(Number.isFinite(m)&&m>0){ws.send(JSON.stringify({type:'admin',action:'setSubmissionWindow',seconds:m*60}));}}
  ui.subClose.onclick=()=>ws.send(JSON.stringify({type:'admin',action:'closeSubmissionsNow'}));
  // HTTP fallback poll
  setInterval(async()=>{try{const r=await fetch('/debug/state',{cache:'no-store'}); render(await r.json());}catch{}},1000);
  let cdTimer;
  function render(state){
    ui.phaseTag.textContent=state.auction.phase; ui.phaseTag.className='tag '+(state.auction.phase==='running'?'success':state.auction.phase==='paused'?'warn':'');
    ui.cur.textContent=state.auction.currentPlayer||'-';
    ui.base.textContent=(state.auction.currentBasePrice||'-');
    if(state.auction.currentBid){const t=state.teams.find(x=>x.id===state.auction.currentBid.teamId); ui.lead.textContent=`${t?t.name:''} ${state.auction.currentBid.amount}`.trim();}
    else {ui.lead.textContent='-';}
    ui.upNext.textContent=state.queue.upNext?state.queue.upNext.name:'-';
    ui.qCount.textContent=state.queue.count;
    ui.pending.textContent=(state.queue.preview||[]).map((n,i)=>`${i+1}. ${n}`).join('\n');
    ui.teams.textContent=state.teams.map(t=>`${t.name||''} - tokens: ${t.tokens}`).join('\n');
    ui.history.textContent=state.auction.history.map(h=>`${new Date(h.ts).toLocaleTimeString()} | ${h.unsold?(h.player+' unsold'):(h.player+' sold to '+(state.teams.find(t=>t.id===h.teamId)?.name||'')+' for '+h.amount)}`).join('\n');
    if(cdTimer) clearInterval(cdTimer);
    const deadline=state.auction.deadlineAt||0; const tick=()=>{const s=Math.max(0,Math.ceil((deadline-Date.now())/1000)); ui.cd.textContent=s+'s';};
    tick(); if(deadline) cdTimer=setInterval(tick,500);
    // submission timer
    if(state.submission && state.submission.countdownSeconds!=null){ ui.subLeft.textContent=state.submission.countdownSeconds+'s'; } else { ui.subLeft.textContent='closed'; }
    if(state.counts){ ui.sold.textContent=state.counts.sold; ui.unsold.textContent=state.counts.unsold; }
  }
</script>
</body>
</html>
